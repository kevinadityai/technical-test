Dalam refactoring ini, saya menerapkan prinsip enkapsulasi dan dependency injection secara konsisten di seluruh aplikasi. Class `DocumentStore` dibuat untuk mengenkapsulasi semua logika storage, baik Qdrant maupun in-memory fallback, sehingga komponen lain tidak perlu tahu detail implementasinya. Semua service diubah menjadi class-based (`EmbeddingService`, `SimpleAnswerService`, `SimpleRetrieverTool`) untuk konsistensi dan memudahkan dependency injection. `WorkflowController` bertindak sebagai composition root yang menginisialisasi semua dependencies secara internal dan menyediakan high-level methods yang langsung bisa dipanggil dari router. Router dibuat sesederhana mungkin hanya menerima request Pydantic dan langsung mendelegasikan ke controller tanpa ada business logic, timing, atau error handling.

Trade-off utama yang saya pertimbangkan adalah antara kesederhanaan kode versus proper architecture. Menggunakan global variables dan functions memang lebih cepat dan sederhana untuk dipahami di awal, namun menciptakan tight coupling yang membuat testing dan maintenance jadi sulit. Saya memilih architecture yang lebih terstruktur meskipun membutuhkan lebih banyak boilerplate code seperti class definitions dan constructors. Keputusan ini diambil karena untuk production code, maintainability dan testability jauh lebih penting daripada kesederhanaan awal. Pada akhirnya, code yang terstruktur dengan baik akan lebih mudah di-scale dan di-maintain dalam jangka panjang.

Versi refactored ini bertujuan meningkatkan maintainability karena beberapa alasan. Pertama, setiap komponen dapat di-test secara isolated dengan mudah karena dependencies-nya explicit dan dapat di-mock. Kedua, separation of concerns yang jelas membuat tanggung jawab setiap layer terdefinisi dengan baik. Misalnya router hanya handle HTTP layer, controller mengatur workflow dan business logic, services melakukan tugas spesifik mereka. Ketiga, jika ingin mengganti implementation (misalnya ganti Qdrant dengan Typesense atau ganti fake embedding dengan real model), cukup modifikasi satu class saja tanpa perlu ubah kode di komponen lain. Keempat, tidak ada hidden dependencies atau global state yang bisa menyebabkan bugs sulit dilacak, semua dependencies jelas terlihat di constructor masing-masing class.
